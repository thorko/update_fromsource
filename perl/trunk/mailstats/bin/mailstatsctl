#!/usr/bin/perl
use DB_File;

$|=1;

use Getopt::Long;                                                                                                                                                                                                                                            
use Config::Simple;
my $config;
my %cc;
my $list;
my $help = 0;

sub help () {
print <<'HELP';
mailstatsctl -c <config> -l <command> [-h]

-c, --config	config file
-l, --list	command
		sent:     list mails sent
		received: list mails received
		rejected: list mails rejected
		bounced:  list mails bounced
		greylist: list mails greylisted
		spam:     list detected as spam
		ham:	  list detected as ham

HELP
}
                                                                                                                                                                                                                                                             
Getopt::Long::Configure('bundling');
GetOptions(
	"h|help" => \$help,
	"l|list=s" => \$list,
        "c|config=s"       => \$config);

if ( $help || !$list || !$config ) {
	help();
	exit(0);
}

die "Couldn't open config $config\n" if ( ! -e $config );
Config::Simple->import_from($config, \%cc) or die Config::Simple->error();

tie(%foo, "DB_File", "$cc{statsdb}", O_RDONLY, 0666, $DB_HASH) || die ("Cannot open $cc{statsdb}");

if ($list =~ /sent/) {
        foreach (sort keys %foo) {
                print $foo{$_}."\n" if $_ =~ /SENT:smtp/;
        }
}
elsif ($list =~ /received/) {
        foreach (sort keys %foo) {
                print $foo{$_}."\n" if $_ =~ /RECEIVED:local/
        }
}
elsif ($list =~ /bounced/) {
        foreach (sort keys %foo) {
                print $foo{$_}."\n" if $_ =~ /BOUNCED/;
        }
}
elsif ($list =~ /rejected/) {
        foreach (sort keys %foo) {
                print $foo{$_}."\n" if $_ =~ /REJECTED/;
        }
}
elsif ($list =~ /greylist/) {
        foreach (sort keys %foo) {
                print $foo{$_}."\n" if $_ =~ /POSTGREY/;
        }
}
elsif ($list =~ /spam/) {
        foreach (sort keys %foo) {
                print $foo{$_}."\n" if $_ =~ /SPAM/;
        }
}
elsif ($list =~ /ham/) {
        foreach (sort keys %foo) {
                print $foo{$_}."\n" if $_ =~ /HAM/;
        }
}
elsif ($list =~ /queue/) {
        @mailq = split(/\n/,`postqueue -p`); @line = split(' ',$mailq[$#mailq]); print $line[4];
        print $mailq;
}

untie %foo;

